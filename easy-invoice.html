<!doctype html>
<html lang="en-ZA">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EasyINV – Invoice Generator</title>
  <meta name="description" content="Create professional invoices with line items, VAT, discounts, preview, and export to PDF, Word, Excel, and CSV — offline-friendly in your browser." />

  <!-- Favicon -->
  <link rel="icon" href="icon.png" type="image/png" />
  <link rel="apple-touch-icon" href="icon.png" />

  <!-- Tailwind (CDN) -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet" />
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- Export libs -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    :root { --brand:#2563eb; --brand2:#1d4ed8; }
    .no-print { display: block; }
    @media print {
      .no-print { display:none !important; }
      body { background:#fff !important; }
      #previewModal { position: static !important; inset:auto !important; display:block !important; }
      #previewCard { box-shadow:none !important; border:none !important; }
    }
    .mono { font-variant-numeric: tabular-nums; }
    .btn { background: var(--brand); }
    .btn:hover { background: var(--brand2); }
    .field { border:1px solid #e5e7eb; border-radius:.5rem; padding:.5rem .75rem; width:100%; }
    .label { font-size:.75rem; color:#6b7280; margin-bottom:.25rem; display:block; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:1rem; }
    .chip { font-size:.75rem; padding:.125rem .5rem; border-radius:999px; border:1px solid #e5e7eb; }
    .table th { font-size:.75rem; color:#6b7280; font-weight:600; text-transform:uppercase; letter-spacing:.04em; }
    .table td, .table th { padding:.5rem .5rem; border-bottom:1px solid #eef2f7; vertical-align:top; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:.75rem; padding:.125rem .375rem; border:1px solid #e5e7eb; border-bottom-width:2px; border-radius:.375rem; background:#f9fafb; }
  </style>
</head>

<body class="bg-gray-50 text-gray-900">
  <!-- NAV (UPDATED: Asset Management + Site Inspection) -->
  <nav class="bg-blue-600 text-white py-4 no-print">
    <div class="container mx-auto px-4 flex flex-wrap items-center gap-4">

      <!-- Brand -->
      <a data-safe-link href="index.html" class="font-black text-xl mr-4">Easy&nbsp;Suite</a>

      <!-- Core Documents -->
      <a data-safe-link href="easy-quote.html" class="hover:underline">Quote</a>
      <a data-safe-link href="easy-invoice.html" class="hover:underline underline font-semibold">Invoice</a>
      <a data-safe-link href="easy-purchase-order.html" class="hover:underline">Purchase&nbsp;Order</a>
      <a data-safe-link href="easy-sales-order.html" class="hover:underline">Sales&nbsp;Order</a>
      <a data-safe-link href="easy-receipt.html" class="hover:underline">Receipt</a>
      <a data-safe-link href="easy-statement.html" class="hover:underline">Statement</a>
      <a data-safe-link href="easy-job-card.html" class="hover:underline">Job&nbsp;Card</a>

      <!-- Operations -->
      <a data-safe-link href="easy-payroll.html" class="hover:underline">Payroll</a>
      <a data-safe-link href="easy-inventory.html" class="hover:underline">Inventory</a>
      <a data-safe-link href="easy-crm.html" class="hover:underline">CRM</a>

      <!-- NEW -->
      <a data-safe-link href="easy-asset-management.html" class="hover:underline">Asset&nbsp;Management</a>
      <a data-safe-link href="easy-site-inspection.html" class="hover:underline">Site&nbsp;Inspection</a>

      <!-- Right Controls -->
      <div class="ml-auto flex items-center gap-2">
        <a data-safe-link href="index.html" class="bg-white/15 hover:bg-white/25 px-3 py-2 rounded-lg text-sm">
          <i class="fa-solid fa-gauge-high mr-2"></i>Dashboard
        </a>

        <button id="btnSaveDraft" class="bg-white/15 hover:bg-white/25 px-3 py-2 rounded-lg text-sm">
          <i class="fa-solid fa-floppy-disk mr-2"></i>Save
        </button>

        <button id="btnLoadDraft" class="bg-white/15 hover:bg-white/25 px-3 py-2 rounded-lg text-sm">
          <i class="fa-solid fa-rotate mr-2"></i>Load
        </button>
      </div>
    </div>
  </nav>

  <main class="container mx-auto px-4 py-6 space-y-6">
    <header class="flex flex-wrap items-center gap-3">
      <div>
        <h1 class="text-2xl font-extrabold">EasyINV</h1>
        <p class="text-gray-600">Feature-rich invoice generator with VAT, discounts, preview, and exports.</p>
      </div>

      <div class="ml-auto flex flex-wrap items-center gap-2 no-print">
        <span class="chip bg-white"><i class="fa-solid fa-bolt mr-2 text-gray-500"></i>Company → Client → Lines → Preview → Export</span>
        <span class="chip bg-white"><i class="fa-solid fa-lock mr-2 text-gray-500"></i>Data stays in your browser (localStorage)</span>
      </div>
    </header>

    <!-- TOP ACTIONS -->
    <section class="card p-4 no-print">
      <div class="flex flex-wrap gap-2 items-center">
        <button id="btnNewInvoice" class="btn text-white px-4 py-2 rounded-lg">
          <i class="fa-solid fa-file-circle-plus mr-2"></i>New Invoice #
        </button>

        <button id="btnMarkPaid" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
          <i class="fa-solid fa-circle-check mr-2"></i>Mark Paid
        </button>

        <div class="ml-auto flex flex-wrap gap-2">
          <button id="btnPreview" class="bg-gray-900 hover:bg-black text-white px-4 py-2 rounded-lg">
            <i class="fa-solid fa-eye mr-2"></i>Preview
          </button>
          <button id="btnPrint" class="bg-white border border-gray-200 hover:bg-gray-50 px-4 py-2 rounded-lg">
            <i class="fa-solid fa-print mr-2"></i>Print
          </button>
          <button id="btnPdf" class="bg-white border border-gray-200 hover:bg-gray-50 px-4 py-2 rounded-lg">
            <i class="fa-solid fa-file-pdf mr-2 text-red-600"></i>Export PDF
          </button>
          <button id="btnWord" class="bg-white border border-gray-200 hover:bg-gray-50 px-4 py-2 rounded-lg">
            <i class="fa-solid fa-file-word mr-2 text-blue-600"></i>Export Word
          </button>
          <button id="btnExcel" class="bg-white border border-gray-200 hover:bg-gray-50 px-4 py-2 rounded-lg">
            <i class="fa-solid fa-file-excel mr-2 text-green-600"></i>Export Excel
          </button>
          <button id="btnCsv" class="bg-white border border-gray-200 hover:bg-gray-50 px-4 py-2 rounded-lg">
            <i class="fa-solid fa-file-csv mr-2 text-gray-700"></i>Export CSV
          </button>
        </div>
      </div>
      <p class="text-xs text-gray-500 mt-3">
        Tips: <span class="kbd">Ctrl</span>+<span class="kbd">S</span> saves. <span class="kbd">Ctrl</span>+<span class="kbd">P</span> prints the preview layout.
      </p>
    </section>

    <!-- FORMS -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Company -->
      <div class="card p-4 space-y-3">
        <h2 class="font-bold text-lg"><i class="fa-solid fa-building mr-2 text-gray-500"></i>Company (Sender)</h2>

        <div>
          <label class="label">Company Logo</label>
          <input id="companyLogo" type="file" accept="image/*" class="field bg-white" />
          <p class="text-xs text-gray-500 mt-1" id="logoHint">No logo uploaded</p>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="label">Company Name</label>
            <input id="companyName" class="field" placeholder="Your Company (Pty) Ltd" />
          </div>
          <div>
            <label class="label">VAT Number</label>
            <input id="companyVat" class="field" placeholder="VAT123..." />
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="label">Reg/CK</label>
            <input id="companyReg" class="field" placeholder="Reg / CK" />
          </div>
          <div>
            <label class="label">Website</label>
            <input id="companyWeb" class="field" placeholder="https://..." />
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="label">Email</label>
            <input id="companyEmail" class="field" placeholder="accounts@..." />
          </div>
          <div>
            <label class="label">Phone</label>
            <input id="companyPhone" class="field" placeholder="+27 ..." />
          </div>
        </div>

        <div>
          <label class="label">Address</label>
          <textarea id="companyAddress" class="field" rows="3" placeholder="Street, Suburb, City, Code"></textarea>
        </div>

        <div>
          <label class="label">Bank Details (optional)</label>
          <textarea id="companyBank" class="field" rows="3" placeholder="Bank, Branch, Acc No, Account Name"></textarea>
        </div>
      </div>

      <!-- Client -->
      <div class="card p-4 space-y-3">
        <h2 class="font-bold text-lg"><i class="fa-solid fa-user-tie mr-2 text-gray-500"></i>Client (Bill To)</h2>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="label">Client Name</label>
            <input id="clientName" class="field" placeholder="Client / Company" />
          </div>
          <div>
            <label class="label">Client VAT</label>
            <input id="clientVat" class="field" placeholder="VAT..." />
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="label">Client Reg/ID</label>
            <input id="clientReg" class="field" placeholder="Reg/ID" />
          </div>
          <div>
            <label class="label">Phone</label>
            <input id="clientPhone" class="field" placeholder="+27 ..." />
          </div>
        </div>

        <div>
          <label class="label">Email</label>
          <input id="clientEmail" class="field" placeholder="billing@..." />
        </div>

        <div>
          <label class="label">Address</label>
          <textarea id="clientAddress" class="field" rows="4" placeholder="Street, Suburb, City, Code"></textarea>
        </div>
      </div>

      <!-- Invoice meta -->
      <div class="card p-4 space-y-3">
        <h2 class="font-bold text-lg"><i class="fa-solid fa-file-invoice mr-2 text-gray-500"></i>Invoice</h2>

        <div class="flex items-center gap-2">
          <span id="statusBadge" class="chip bg-yellow-50 border-yellow-200 text-yellow-900">
            <i class="fa-solid fa-pen-to-square mr-2"></i><span id="statusText">DRAFT</span>
          </span>
          <span class="text-xs text-gray-500">Status drives the preview label and overdue display.</span>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="label">Invoice #</label>
            <input id="invNumber" class="field mono" placeholder="INV-0001" />
          </div>
          <div>
            <label class="label">Reference</label>
            <input id="invRef" class="field" placeholder="PO / Ref" />
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="label">Issue Date</label>
            <input id="issueDate" type="date" class="field" />
          </div>
          <div>
            <label class="label">Due Date</label>
            <input id="dueDate" type="date" class="field" />
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="label">Currency</label>
            <select id="currency" class="field bg-white">
              <option value="ZAR" selected>ZAR (R)</option>
              <option value="USD">USD ($)</option>
              <option value="EUR">EUR (€)</option>
              <option value="GBP">GBP (£)</option>
            </select>
            <p class="text-xs text-gray-500 mt-1">Formatting adapts; no FX conversion.</p>
          </div>
          <div>
            <label class="label">Status</label>
            <select id="status" class="field bg-white">
              <option value="Draft" selected>Draft</option>
              <option value="Sent">Sent</option>
              <option value="Partially Paid">Partially Paid</option>
              <option value="Paid">Paid</option>
              <option value="Overdue">Overdue</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="label">Overall Discount %</label>
            <input id="overallDiscount" type="number" step="0.01" min="0" class="field mono" value="0" />
          </div>
          <div>
            <label class="label">Default VAT % (new lines)</label>
            <input id="defaultVat" type="number" step="0.01" min="0" class="field mono" value="15" />
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="label">Shipping / Delivery</label>
            <input id="shipping" type="number" step="0.01" min="0" class="field mono" value="0" />
          </div>
          <div>
            <label class="label">Amount Paid</label>
            <input id="amountPaid" type="number" step="0.01" min="0" class="field mono" value="0" />
          </div>
        </div>
      </div>
    </section>

    <!-- LINE ITEMS -->
    <section class="card p-4 space-y-4">
      <div class="flex flex-wrap gap-2 items-center">
        <h2 class="font-bold text-lg"><i class="fa-solid fa-list mr-2 text-gray-500"></i>Line Items</h2>
        <div class="ml-auto flex flex-wrap gap-2 no-print">
          <label class="bg-white border border-gray-200 hover:bg-gray-50 px-4 py-2 rounded-lg cursor-pointer">
            <i class="fa-solid fa-file-import mr-2"></i>Import CSV
            <input id="csvImport" type="file" accept=".csv,text/csv" class="hidden" />
          </label>
          <button id="btnAddLine" class="btn text-white px-4 py-2 rounded-lg">
            <i class="fa-solid fa-plus mr-2"></i>Add Line
          </button>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full table">
          <thead>
            <tr>
              <th class="text-left">Description</th>
              <th class="text-right">Qty</th>
              <th class="text-right">Rate (Excl.)</th>
              <th class="text-right">Disc %</th>
              <th class="text-right">VAT %</th>
              <th class="text-right">Total Excl.</th>
              <th class="text-right">Total Incl.</th>
              <th class="text-right no-print">Action</th>
            </tr>
          </thead>
          <tbody id="linesBody"></tbody>
        </table>
      </div>

      <p class="text-xs text-gray-500">
        CSV Import columns: <b>Description,Qty,RateExcl,DiscountPct,VatPct</b>. Discount logic: line discount → overall discount → VAT.
      </p>
    </section>

    <!-- TOTALS -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="lg:col-span-2 card p-4 space-y-3">
        <h2 class="font-bold text-lg"><i class="fa-solid fa-notes-medical mr-2 text-gray-500"></i>Notes & Terms</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="label">Invoice Notes</label>
            <textarea id="notes" class="field" rows="6" placeholder="Thank you for your business."></textarea>
          </div>
          <div>
            <label class="label">Payment Terms</label>
            <textarea id="terms" class="field" rows="6" placeholder="Payment due within 7 days. Late payments may incur fees."></textarea>
          </div>
        </div>
      </div>

      <div class="card p-4 space-y-3">
        <h2 class="font-bold text-lg"><i class="fa-solid fa-calculator mr-2 text-gray-500"></i>Totals</h2>

        <div class="space-y-2 text-sm">
          <div class="flex justify-between"><span class="text-gray-600">Subtotal (Excl.)</span><span id="tSubtotalEx" class="mono font-semibold">R 0.00</span></div>
          <div class="flex justify-between"><span class="text-gray-600">Overall Discount</span><span id="tOverallDiscount" class="mono font-semibold">R 0.00</span></div>
          <div class="flex justify-between"><span class="text-gray-600">Shipping</span><span id="tShipping" class="mono font-semibold">R 0.00</span></div>
          <div class="flex justify-between"><span class="text-gray-600">VAT</span><span id="tVat" class="mono font-semibold">R 0.00</span></div>
          <hr />
          <div class="flex justify-between text-lg"><span class="font-extrabold">Total (Incl.)</span><span id="tTotal" class="mono font-extrabold">R 0.00</span></div>
          <div class="flex justify-between"><span class="text-gray-600">Paid</span><span id="tPaid" class="mono font-semibold">R 0.00</span></div>
          <div class="flex justify-between"><span class="text-gray-600">Balance Due</span><span id="tBalance" class="mono font-semibold">R 0.00</span></div>
        </div>

        <div class="no-print text-xs text-gray-500">
          Auto-save: Draft is stored locally when you click Save (or Ctrl+S).
        </div>
      </div>
    </section>
  </main>

  <!-- PREVIEW MODAL -->
  <div id="previewModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center p-4 z-50">
    <div class="max-w-4xl w-full">
      <div class="flex items-center gap-2 mb-2 no-print">
        <button id="btnClosePreview" class="bg-white hover:bg-gray-50 border border-gray-200 px-3 py-2 rounded-lg">
          <i class="fa-solid fa-xmark mr-2"></i>Close
        </button>
        <button id="btnPrint2" class="bg-white hover:bg-gray-50 border border-gray-200 px-3 py-2 rounded-lg">
          <i class="fa-solid fa-print mr-2"></i>Print
        </button>
        <button id="btnPdf2" class="bg-white hover:bg-gray-50 border border-gray-200 px-3 py-2 rounded-lg">
          <i class="fa-solid fa-file-pdf mr-2 text-red-600"></i>PDF
        </button>
        <button id="btnWord2" class="bg-white hover:bg-gray-50 border border-gray-200 px-3 py-2 rounded-lg">
          <i class="fa-solid fa-file-word mr-2 text-blue-600"></i>Word
        </button>
        <button id="btnExcel2" class="bg-white hover:bg-gray-50 border border-gray-200 px-3 py-2 rounded-lg">
          <i class="fa-solid fa-file-excel mr-2 text-green-600"></i>Excel
        </button>
        <button id="btnCsv2" class="bg-white hover:bg-gray-50 border border-gray-200 px-3 py-2 rounded-lg">
          <i class="fa-solid fa-file-csv mr-2 text-gray-700"></i>CSV
        </button>
      </div>

      <div id="previewCard" class="card p-8 bg-white shadow-xl">
        <!-- Preview content injected -->
        <div id="previewContent"></div>
      </div>
    </div>
  </div>

  <!-- Optional shared nav sync (safe if missing) -->
  <script defer src="sync-nav.js"></script>

  <script>
    // ---------- Utilities ----------
    const $ = (id) => document.getElementById(id);

    function safeNumber(v) {
      const n = Number(String(v ?? "").replace(/[^0-9.\-]/g, ""));
      return Number.isFinite(n) ? n : 0;
    }

    function pad(n, w = 4) {
      const s = String(n);
      return s.length >= w ? s : "0".repeat(w - s.length) + s;
    }

    function todayISO() {
      const d = new Date();
      const tzOff = d.getTimezoneOffset() * 60000;
      return new Date(d - tzOff).toISOString().slice(0,10);
    }

    function currencySymbol(code) {
      switch (code) {
        case "USD": return "$";
        case "EUR": return "€";
        case "GBP": return "£";
        default: return "R";
      }
    }

    function formatMoney(code, amount) {
      const sym = currencySymbol(code);
      const n = (Number.isFinite(amount) ? amount : 0);
      return `${sym} ${n.toFixed(2)}`;
    }

    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function setStatusBadge(val) {
      const badge = $("statusBadge");
      const text = $("statusText");
      text.textContent = String(val || "Draft").toUpperCase();

      // reset classes
      badge.className = "chip";
      if (val === "Paid") {
        badge.classList.add("bg-green-50","border-green-200","text-green-900");
      } else if (val === "Overdue") {
        badge.classList.add("bg-red-50","border-red-200","text-red-900");
      } else if (val === "Sent") {
        badge.classList.add("bg-blue-50","border-blue-200","text-blue-900");
      } else if (val === "Partially Paid") {
        badge.classList.add("bg-purple-50","border-purple-200","text-purple-900");
      } else {
        badge.classList.add("bg-yellow-50","border-yellow-200","text-yellow-900");
      }
    }

    // ---------- Line Items Model ----------
    let lines = [];

    function newLine(prefVat) {
      return {
        desc: "",
        qty: 1,
        rate: 0,
        disc: 0,
        vat: safeNumber(prefVat),
      };
    }

    function calcLine(line) {
      const qty = Math.max(0, safeNumber(line.qty));
      const rate = Math.max(0, safeNumber(line.rate));
      const discPct = Math.min(100, Math.max(0, safeNumber(line.disc)));
      const vatPct = Math.min(100, Math.max(0, safeNumber(line.vat)));

      const gross = qty * rate;
      const disc = gross * (discPct / 100);
      const netEx = gross - disc;
      const vat = netEx * (vatPct / 100);
      const netInc = netEx + vat;

      return { qty, rate, discPct, vatPct, gross, disc, netEx, vat, netInc };
    }

    function renderLines() {
      const tbody = $("linesBody");
      tbody.innerHTML = "";

      if (lines.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="text-center text-gray-500 py-6">
              No line items yet. Click <b>Add Line</b> to start.
            </td>
          </tr>`;
        recalcTotals();
        return;
      }

      lines.forEach((line, idx) => {
        const c = calcLine(line);
        const cur = $("currency").value;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="w-2/5">
            <textarea class="field" rows="2" placeholder="e.g., Consulting services" data-k="desc" data-i="${idx}">${escapeHtml(line.desc)}</textarea>
          </td>
          <td class="text-right">
            <input class="field mono text-right" type="number" min="0" step="0.01" value="${c.qty}" data-k="qty" data-i="${idx}" />
          </td>
          <td class="text-right">
            <input class="field mono text-right" type="number" min="0" step="0.01" value="${c.rate}" data-k="rate" data-i="${idx}" />
          </td>
          <td class="text-right">
            <input class="field mono text-right" type="number" min="0" max="100" step="0.01" value="${c.discPct}" data-k="disc" data-i="${idx}" />
          </td>
          <td class="text-right">
            <input class="field mono text-right" type="number" min="0" max="100" step="0.01" value="${c.vatPct}" data-k="vat" data-i="${idx}" />
          </td>
          <td class="text-right mono font-semibold">${formatMoney(cur, c.netEx)}</td>
          <td class="text-right mono font-semibold">${formatMoney(cur, c.netInc)}</td>
          <td class="text-right no-print">
            <button class="bg-white border border-gray-200 hover:bg-gray-50 px-3 py-2 rounded-lg" data-act="del" data-i="${idx}">
              <i class="fa-solid fa-trash text-red-600"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      // Inputs events
      tbody.querySelectorAll("input,textarea").forEach(el => {
        el.addEventListener("input", (e) => {
          const i = Number(e.target.getAttribute("data-i"));
          const k = e.target.getAttribute("data-k");
          if (!Number.isFinite(i) || !k) return;

          if (k === "desc") lines[i][k] = e.target.value;
          else lines[i][k] = safeNumber(e.target.value);

          recalcTotals();
        });
      });

      tbody.querySelectorAll("button[data-act='del']").forEach(btn => {
        btn.addEventListener("click", () => {
          const i = Number(btn.getAttribute("data-i"));
          lines.splice(i, 1);
          renderLines();
        });
      });

      recalcTotals();
    }

    // ---------- Totals ----------
    function recalcTotals() {
      const cur = $("currency").value;

      const subtotalEx = lines.reduce((s, ln) => s + calcLine(ln).netEx, 0);
      const vatTotal = lines.reduce((s, ln) => s + calcLine(ln).vat, 0);

      const overallDiscPct = Math.min(100, Math.max(0, safeNumber($("overallDiscount").value)));
      const overallDiscount = subtotalEx * (overallDiscPct / 100);

      const shipping = Math.max(0, safeNumber($("shipping").value));
      const paid = Math.max(0, safeNumber($("amountPaid").value));

      // Apply overall discount to subtotalEx; VAT already calculated per line on netEx.
      // If you want overall discount to reduce VAT proportionally, you can adjust VAT here.
      const discountedEx = Math.max(0, subtotalEx - overallDiscount);
      const totalInc = discountedEx + vatTotal + shipping;
      const balance = Math.max(0, totalInc - paid);

      $("tSubtotalEx").textContent = formatMoney(cur, subtotalEx);
      $("tOverallDiscount").textContent = `- ${formatMoney(cur, overallDiscount)}`;
      $("tShipping").textContent = formatMoney(cur, shipping);
      $("tVat").textContent = formatMoney(cur, vatTotal);
      $("tTotal").textContent = formatMoney(cur, totalInc);
      $("tPaid").textContent = formatMoney(cur, paid);
      $("tBalance").textContent = formatMoney(cur, balance);

      // Status automation: if Paid >= Total then Paid
      if (paid > 0 && paid + 0.0001 >= totalInc && totalInc > 0) {
        $("status").value = "Paid";
      } else if ($("status").value === "Paid" && paid + 0.0001 < totalInc) {
        $("status").value = "Partially Paid";
      }
      setStatusBadge($("status").value);
    }

    // ---------- Draft Save/Load ----------
    const DRAFT_KEY = "easyinv:draft:v2";

    function getDraft() {
      return {
        meta: {
          invNumber: $("invNumber").value,
          invRef: $("invRef").value,
          issueDate: $("issueDate").value,
          dueDate: $("dueDate").value,
          currency: $("currency").value,
          status: $("status").value,
          overallDiscount: safeNumber($("overallDiscount").value),
          defaultVat: safeNumber($("defaultVat").value),
          shipping: safeNumber($("shipping").value),
          amountPaid: safeNumber($("amountPaid").value),
        },
        company: {
          name: $("companyName").value,
          vat: $("companyVat").value,
          reg: $("companyReg").value,
          web: $("companyWeb").value,
          email: $("companyEmail").value,
          phone: $("companyPhone").value,
          address: $("companyAddress").value,
          bank: $("companyBank").value,
          logoDataUrl: window.__companyLogoDataUrl || "",
        },
        client: {
          name: $("clientName").value,
          vat: $("clientVat").value,
          reg: $("clientReg").value,
          phone: $("clientPhone").value,
          email: $("clientEmail").value,
          address: $("clientAddress").value,
        },
        notes: $("notes").value,
        terms: $("terms").value,
        lines: lines,
      };
    }

    function applyDraft(d) {
      if (!d) return;

      $("invNumber").value = d.meta?.invNumber || $("invNumber").value;
      $("invRef").value = d.meta?.invRef || "";
      $("issueDate").value = d.meta?.issueDate || todayISO();
      $("dueDate").value = d.meta?.dueDate || "";
      $("currency").value = d.meta?.currency || "ZAR";
      $("status").value = d.meta?.status || "Draft";
      $("overallDiscount").value = safeNumber(d.meta?.overallDiscount || 0);
      $("defaultVat").value = safeNumber(d.meta?.defaultVat ?? 15);
      $("shipping").value = safeNumber(d.meta?.shipping || 0);
      $("amountPaid").value = safeNumber(d.meta?.amountPaid || 0);

      $("companyName").value = d.company?.name || "";
      $("companyVat").value = d.company?.vat || "";
      $("companyReg").value = d.company?.reg || "";
      $("companyWeb").value = d.company?.web || "";
      $("companyEmail").value = d.company?.email || "";
      $("companyPhone").value = d.company?.phone || "";
      $("companyAddress").value = d.company?.address || "";
      $("companyBank").value = d.company?.bank || "";
      window.__companyLogoDataUrl = d.company?.logoDataUrl || "";
      $("logoHint").textContent = window.__companyLogoDataUrl ? "Logo loaded from last saved draft" : "No logo uploaded";

      $("clientName").value = d.client?.name || "";
      $("clientVat").value = d.client?.vat || "";
      $("clientReg").value = d.client?.reg || "";
      $("clientPhone").value = d.client?.phone || "";
      $("clientEmail").value = d.client?.email || "";
      $("clientAddress").value = d.client?.address || "";

      $("notes").value = d.notes || "";
      $("terms").value = d.terms || "";

      lines = Array.isArray(d.lines) ? d.lines : [];
      setStatusBadge($("status").value);
      renderLines();
    }

    function saveDraft() {
      try {
        localStorage.setItem(DRAFT_KEY, JSON.stringify(getDraft()));
        toast("Draft saved ✅");
      } catch {
        toast("Could not save draft (storage blocked).", true);
      }
    }

    function loadDraft() {
      try {
        const raw = localStorage.getItem(DRAFT_KEY);
        if (!raw) return toast("No saved draft found.", true);
        applyDraft(JSON.parse(raw));
        toast("Draft loaded ✅");
      } catch {
        toast("Could not load draft.", true);
      }
    }

    // ---------- Toast ----------
    let toastTimer = null;
    function toast(msg, isError=false) {
      let el = document.getElementById("toast");
      if (!el) {
        el = document.createElement("div");
        el.id = "toast";
        el.className = "fixed bottom-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg text-sm";
        document.body.appendChild(el);
      }
      el.className = `fixed bottom-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg text-sm ${isError ? "bg-red-600 text-white" : "bg-gray-900 text-white"}`;
      el.textContent = msg;
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => el.remove(), 2200);
    }

    // ---------- Invoice # ----------
    function newInvoiceNumber() {
      const key = "easyinv:lastNumber";
      const last = safeNumber(localStorage.getItem(key) || "0");
      const next = last + 1;
      localStorage.setItem(key, String(next));
      $("invNumber").value = `INV-${pad(next, 5)}`;
    }

    // ---------- Preview ----------
    function buildPreviewHtml() {
      const cur = $("currency").value;
      const sym = currencySymbol(cur);

      // totals (reuse computed)
      const subtotalEx = lines.reduce((s, ln) => s + calcLine(ln).netEx, 0);
      const vatTotal = lines.reduce((s, ln) => s + calcLine(ln).vat, 0);
      const overallDiscPct = Math.min(100, Math.max(0, safeNumber($("overallDiscount").value)));
      const overallDiscount = subtotalEx * (overallDiscPct / 100);
      const shipping = Math.max(0, safeNumber($("shipping").value));
      const discountedEx = Math.max(0, subtotalEx - overallDiscount);
      const totalInc = discountedEx + vatTotal + shipping;
      const paid = Math.max(0, safeNumber($("amountPaid").value));
      const balance = Math.max(0, totalInc - paid);

      const due = $("dueDate").value;
      const issue = $("issueDate").value;
      const status = $("status").value;

      const logoHtml = window.__companyLogoDataUrl
        ? `<img src="${window.__companyLogoDataUrl}" alt="Logo" style="max-height:70px; max-width:220px; object-fit:contain;">`
        : `<div style="height:70px; width:220px; border:1px dashed #d1d5db; border-radius:12px; display:flex; align-items:center; justify-content:center; color:#6b7280; font-size:12px;">Logo</div>`;

      const lineRows = (lines.length ? lines : [newLine($("defaultVat").value)]).map((ln) => {
        const c = calcLine(ln);
        return `
          <tr>
            <td style="padding:8px 6px; border-bottom:1px solid #eef2f7;">${escapeHtml(ln.desc || "")}</td>
            <td style="padding:8px 6px; border-bottom:1px solid #eef2f7; text-align:right;">${c.qty.toFixed(2)}</td>
            <td style="padding:8px 6px; border-bottom:1px solid #eef2f7; text-align:right;">${sym} ${c.rate.toFixed(2)}</td>
            <td style="padding:8px 6px; border-bottom:1px solid #eef2f7; text-align:right;">${c.discPct.toFixed(2)}%</td>
            <td style="padding:8px 6px; border-bottom:1px solid #eef2f7; text-align:right;">${c.vatPct.toFixed(2)}%</td>
            <td style="padding:8px 6px; border-bottom:1px solid #eef2f7; text-align:right;">${sym} ${c.netEx.toFixed(2)}</td>
            <td style="padding:8px 6px; border-bottom:1px solid #eef2f7; text-align:right;">${sym} ${c.netInc.toFixed(2)}</td>
          </tr>
        `;
      }).join("");

      const overdueNote = (status === "Overdue")
        ? `<div style="margin-top:10px; padding:10px 12px; background:#fef2f2; border:1px solid #fecaca; border-radius:12px; color:#991b1b;">
             <b>Overdue:</b> Payment was due on ${escapeHtml(due || "—")}.
           </div>`
        : "";

      return `
        <div style="font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; color:#111827;">
          <div style="display:flex; justify-content:space-between; gap:18px; align-items:flex-start;">
            <div>
              ${logoHtml}
              <div style="margin-top:10px;">
                <div style="font-weight:800; font-size:18px;">${escapeHtml($("companyName").value || "Your Company")}</div>
                <div style="font-size:12px; color:#4b5563; white-space:pre-line;">${escapeHtml($("companyAddress").value || "")}</div>
                <div style="font-size:12px; color:#4b5563; margin-top:6px;">
                  ${$("companyEmail").value ? `Email: ${escapeHtml($("companyEmail").value)}<br>` : ""}
                  ${$("companyPhone").value ? `Phone: ${escapeHtml($("companyPhone").value)}<br>` : ""}
                  ${$("companyVat").value ? `VAT: ${escapeHtml($("companyVat").value)}<br>` : ""}
                  ${$("companyReg").value ? `Reg: ${escapeHtml($("companyReg").value)}<br>` : ""}
                  ${$("companyWeb").value ? `Web: ${escapeHtml($("companyWeb").value)}` : ""}
                </div>
              </div>
            </div>

            <div style="text-align:right; min-width:260px;">
              <div style="font-weight:900; font-size:28px; color:#1d4ed8;">INVOICE</div>
              <div style="margin-top:6px; font-size:12px; color:#4b5563;">
                <div><b>Status:</b> ${escapeHtml(status)}</div>
                <div><b>Invoice #:</b> ${escapeHtml($("invNumber").value || "—")}</div>
                <div><b>Reference:</b> ${escapeHtml($("invRef").value || "—")}</div>
                <div><b>Issue Date:</b> ${escapeHtml(issue || "—")}</div>
                <div><b>Due Date:</b> ${escapeHtml(due || "—")}</div>
              </div>
              ${overdueNote}
            </div>
          </div>

          <div style="margin-top:22px; display:flex; gap:18px;">
            <div style="flex:1; border:1px solid #e5e7eb; border-radius:14px; padding:12px 14px;">
              <div style="font-weight:800; margin-bottom:6px;">Bill To</div>
              <div style="font-size:12px;">
                <div style="font-weight:700;">${escapeHtml($("clientName").value || "Client")}</div>
                <div style="color:#4b5563; white-space:pre-line;">${escapeHtml($("clientAddress").value || "")}</div>
                <div style="color:#4b5563; margin-top:6px;">
                  ${$("clientEmail").value ? `Email: ${escapeHtml($("clientEmail").value)}<br>` : ""}
                  ${$("clientPhone").value ? `Phone: ${escapeHtml($("clientPhone").value)}<br>` : ""}
                  ${$("clientVat").value ? `VAT: ${escapeHtml($("clientVat").value)}<br>` : ""}
                  ${$("clientReg").value ? `Reg/ID: ${escapeHtml($("clientReg").value)}` : ""}
                </div>
              </div>
            </div>

            <div style="width:320px; border:1px solid #e5e7eb; border-radius:14px; padding:12px 14px;">
              <div style="font-weight:800; margin-bottom:6px;">Totals</div>
              <div style="font-size:12px; color:#111827;">
                <div style="display:flex; justify-content:space-between;"><span>Subtotal (Excl.)</span><b>${sym} ${subtotalEx.toFixed(2)}</b></div>
                <div style="display:flex; justify-content:space-between;"><span>Overall Discount</span><b>- ${sym} ${overallDiscount.toFixed(2)}</b></div>
                <div style="display:flex; justify-content:space-between;"><span>Shipping</span><b>${sym} ${shipping.toFixed(2)}</b></div>
                <div style="display:flex; justify-content:space-between;"><span>VAT</span><b>${sym} ${vatTotal.toFixed(2)}</b></div>
                <hr style="margin:10px 0;">
                <div style="display:flex; justify-content:space-between; font-size:16px;"><span><b>Total (Incl.)</b></span><span><b>${sym} ${totalInc.toFixed(2)}</b></span></div>
                <div style="display:flex; justify-content:space-between;"><span>Paid</span><b>${sym} ${paid.toFixed(2)}</b></div>
                <div style="display:flex; justify-content:space-between;"><span>Balance Due</span><b>${sym} ${balance.toFixed(2)}</b></div>
              </div>
            </div>
          </div>

          <div style="margin-top:18px;">
            <table style="width:100%; border-collapse:collapse;">
              <thead>
                <tr>
                  <th style="text-align:left; font-size:11px; color:#6b7280; padding:8px 6px; border-bottom:1px solid #e5e7eb;">Description</th>
                  <th style="text-align:right; font-size:11px; color:#6b7280; padding:8px 6px; border-bottom:1px solid #e5e7eb;">Qty</th>
                  <th style="text-align:right; font-size:11px; color:#6b7280; padding:8px 6px; border-bottom:1px solid #e5e7eb;">Rate (Excl.)</th>
                  <th style="text-align:right; font-size:11px; color:#6b7280; padding:8px 6px; border-bottom:1px solid #e5e7eb;">Disc</th>
                  <th style="text-align:right; font-size:11px; color:#6b7280; padding:8px 6px; border-bottom:1px solid #e5e7eb;">VAT</th>
                  <th style="text-align:right; font-size:11px; color:#6b7280; padding:8px 6px; border-bottom:1px solid #e5e7eb;">Total Excl.</th>
                  <th style="text-align:right; font-size:11px; color:#6b7280; padding:8px 6px; border-bottom:1px solid #e5e7eb;">Total Incl.</th>
                </tr>
              </thead>
              <tbody>${lineRows}</tbody>
            </table>
          </div>

          <div style="margin-top:18px; display:flex; gap:18px;">
            <div style="flex:1;">
              <div style="font-weight:800; margin-bottom:6px;">Notes</div>
              <div style="font-size:12px; color:#4b5563; white-space:pre-line;">${escapeHtml($("notes").value || "")}</div>
            </div>
            <div style="flex:1;">
              <div style="font-weight:800; margin-bottom:6px;">Terms</div>
              <div style="font-size:12px; color:#4b5563; white-space:pre-line;">${escapeHtml($("terms").value || "")}</div>
              ${$("companyBank").value ? `<div style="margin-top:10px; font-size:12px;"><b>Bank:</b><div style="white-space:pre-line; color:#4b5563;">${escapeHtml($("companyBank").value)}</div></div>` : ""}
            </div>
          </div>

          <div style="margin-top:18px; font-size:11px; color:#9ca3af;">
            Generated by EasyINV (Easy Suite) • Offline-friendly • ${new Date().toLocaleString()}
          </div>
        </div>
      `;
    }

    function openPreview() {
      $("previewContent").innerHTML = buildPreviewHtml();
      $("previewModal").classList.remove("hidden");
      $("previewModal").classList.add("flex");
    }

    function closePreview() {
      $("previewModal").classList.add("hidden");
      $("previewModal").classList.remove("flex");
    }

    // ---------- Exports ----------
    function filenameBase() {
      return ($("invNumber").value || "invoice").replace(/[^\w\-]+/g, "_");
    }

    function exportCSV() {
      const cur = $("currency").value;
      const rows = [];
      rows.push(["InvoiceNumber", $("invNumber").value || ""], ["Reference", $("invRef").value || ""], ["Currency", cur], ["IssueDate", $("issueDate").value || ""], ["DueDate", $("dueDate").value || ""], []);
      rows.push(["CompanyName", $("companyName").value || ""], ["CompanyVAT", $("companyVat").value || ""], ["CompanyEmail", $("companyEmail").value || ""], ["CompanyPhone", $("companyPhone").value || ""], ["CompanyAddress", $("companyAddress").value || ""], []);
      rows.push(["ClientName", $("clientName").value || ""], ["ClientVAT", $("clientVat").value || ""], ["ClientEmail", $("clientEmail").value || ""], ["ClientPhone", $("clientPhone").value || ""], ["ClientAddress", $("clientAddress").value || ""], []);
      rows.push(["Description","Qty","RateExcl","DiscountPct","VatPct","TotalExcl","TotalIncl"]);

      lines.forEach(ln => {
        const c = calcLine(ln);
        rows.push([ln.desc || "", c.qty, c.rate, c.discPct, c.vatPct, c.netEx, c.netInc]);
      });

      const csv = rows.map(r => r.map(v => {
        const s = String(v ?? "");
        return /[",\n]/.test(s) ? `"${s.replaceAll('"','""')}"` : s;
      }).join(",")).join("\n");

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `${filenameBase()}.csv`;
      a.click();
      URL.revokeObjectURL(a.href);
      toast("CSV exported ✅");
    }

    function exportExcel() {
      if (!window.XLSX) return toast("Excel export library not loaded.", true);

      const wsData = [
        ["Invoice #", $("invNumber").value || ""],
        ["Reference", $("invRef").value || ""],
        ["Issue Date", $("issueDate").value || ""],
        ["Due Date", $("dueDate").value || ""],
        ["Currency", $("currency").value || ""],
        [],
        ["Description","Qty","RateExcl","DiscountPct","VatPct","TotalExcl","TotalIncl"],
      ];

      lines.forEach(ln => {
        const c = calcLine(ln);
        wsData.push([ln.desc || "", c.qty, c.rate, c.discPct, c.vatPct, c.netEx, c.netInc]);
      });

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      XLSX.utils.book_append_sheet(wb, ws, "Invoice");
      XLSX.writeFile(wb, `${filenameBase()}.xlsx`);
      toast("Excel exported ✅");
    }

    function exportWord() {
      // Simple HTML-to-Word download using .doc (works well for most clients)
      const html = `
        <html><head><meta charset="utf-8"></head><body>
          ${buildPreviewHtml()}
        </body></html>`;
      const blob = new Blob(["\ufeff", html], { type: "application/msword" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `${filenameBase()}.doc`;
      a.click();
      URL.revokeObjectURL(a.href);
      toast("Word exported ✅");
    }

    async function exportPDF() {
      const card = document.getElementById("previewCard");
      const modalWasHidden = $("previewModal").classList.contains("hidden");

      // Ensure preview content exists (for clean render)
      $("previewContent").innerHTML = buildPreviewHtml();
      if (modalWasHidden) {
        $("previewModal").classList.remove("hidden");
        $("previewModal").classList.add("flex");
        // keep visually off? It's modal; acceptable as user triggered export.
      }

      try {
        const canvas = await html2canvas(card, { scale: 2, useCORS: true, backgroundColor: "#ffffff" });
        const imgData = canvas.toDataURL("image/png");
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF("p", "mm", "a4");

        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();

        const imgProps = pdf.getImageProperties(imgData);
        const imgWidth = pageWidth;
        const imgHeight = (imgProps.height * imgWidth) / imgProps.width;

        let heightLeft = imgHeight;
        let position = 0;

        pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight, undefined, "FAST");
        heightLeft -= pageHeight;

        while (heightLeft > 0) {
          position = heightLeft - imgHeight;
          pdf.addPage();
          pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight, undefined, "FAST");
          heightLeft -= pageHeight;
        }

        pdf.save(`${filenameBase()}.pdf`);
        toast("PDF exported ✅");
      } catch (e) {
        toast("PDF export failed. Try again.", true);
      } finally {
        if (modalWasHidden) {
          closePreview();
        }
      }
    }

    // ---------- CSV Import ----------
    function parseCSV(text) {
      // Minimal CSV parser (handles quotes)
      const rows = [];
      let i = 0, field = "", row = [], inQuotes = false;

      while (i < text.length) {
        const c = text[i];
        if (inQuotes) {
          if (c === '"') {
            if (text[i + 1] === '"') { field += '"'; i += 2; continue; }
            inQuotes = false; i++; continue;
          }
          field += c; i++; continue;
        } else {
          if (c === '"') { inQuotes = true; i++; continue; }
          if (c === ",") { row.push(field); field = ""; i++; continue; }
          if (c === "\n") { row.push(field); rows.push(row); field = ""; row = []; i++; continue; }
          if (c === "\r") { i++; continue; }
          field += c; i++; continue;
        }
      }
      row.push(field);
      rows.push(row);
      return rows;
    }

    function importCSV(file) {
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const rows = parseCSV(String(reader.result || ""));
          const header = rows[0].map(h => (h || "").trim().toLowerCase());

          const idx = (name) => header.indexOf(name.toLowerCase());
          const iDesc = idx("description");
          const iQty = idx("qty");
          const iRate = idx("rateexcl");
          const iDisc = idx("discountpct");
          const iVat = idx("vatpct");

          if (iDesc === -1 || iQty === -1 || iRate === -1) {
            return toast("CSV missing required columns (Description, Qty, RateExcl).", true);
          }

          const imported = [];
          for (let r = 1; r < rows.length; r++) {
            const row = rows[r];
            if (!row || row.length === 0) continue;
            const desc = (row[iDesc] || "").trim();
            if (!desc) continue;

            imported.push({
              desc,
              qty: safeNumber(row[iQty]),
              rate: safeNumber(row[iRate]),
              disc: iDisc >= 0 ? safeNumber(row[iDisc]) : 0,
              vat: iVat >= 0 ? safeNumber(row[iVat]) : safeNumber($("defaultVat").value),
            });
          }

          if (!imported.length) return toast("No valid lines found in CSV.", true);
          lines = imported;
          renderLines();
          toast(`Imported ${imported.length} line(s) ✅`);
        } catch {
          toast("Could not import CSV.", true);
        }
      };
      reader.readAsText(file, "utf-8");
    }

    // ---------- Logo Upload ----------
    function handleLogoUpload(file) {
      const reader = new FileReader();
      reader.onload = () => {
        window.__companyLogoDataUrl = String(reader.result || "");
        $("logoHint").textContent = "Logo uploaded (will export in preview)";
        toast("Logo uploaded ✅");
      };
      reader.readAsDataURL(file);
    }

    // ---------- Auto highlight current page in nav (for every page) ----------
    function highlightActiveNav() {
      const current = location.pathname.split("/").pop() || "index.html";
      document.querySelectorAll("nav a[data-safe-link]").forEach(a => {
        const href = a.getAttribute("href") || "";
        if (href === current) a.classList.add("underline","font-semibold");
        else a.classList.remove("underline","font-semibold");
      });
    }

    // ---------- Init ----------
    function init() {
      // Defaults
      if (!$("issueDate").value) $("issueDate").value = todayISO();
      if (!$("invNumber").value) newInvoiceNumber();

      setStatusBadge($("status").value);

      // Start with one line
      lines = [ newLine($("defaultVat").value) ];
      renderLines();

      // Events
      $("btnAddLine").addEventListener("click", () => {
        lines.push(newLine($("defaultVat").value));
        renderLines();
      });

      $("btnNewInvoice").addEventListener("click", () => {
        newInvoiceNumber();
        toast("New invoice number generated ✅");
      });

      $("btnMarkPaid").addEventListener("click", () => {
        $("status").value = "Paid";
        setStatusBadge("Paid");
        recalcTotals();
        toast("Marked as PAID ✅");
      });

      $("status").addEventListener("change", () => setStatusBadge($("status").value));

      ["currency","overallDiscount","defaultVat","shipping","amountPaid"].forEach(id => {
        $(id).addEventListener("input", () => {
          // Update default VAT only for new lines; existing lines unchanged.
          renderLines();
        });
      });

      $("btnPreview").addEventListener("click", openPreview);
      $("btnClosePreview").addEventListener("click", closePreview);
      $("previewModal").addEventListener("click", (e) => {
        if (e.target === $("previewModal")) closePreview();
      });

      // Print
      $("btnPrint").addEventListener("click", () => { openPreview(); setTimeout(() => window.print(), 150); });
      $("btnPrint2").addEventListener("click", () => window.print());

      // Exports (main + preview)
      $("btnCsv").addEventListener("click", exportCSV);
      $("btnExcel").addEventListener("click", exportExcel);
      $("btnWord").addEventListener("click", exportWord);
      $("btnPdf").addEventListener("click", exportPDF);

      $("btnCsv2").addEventListener("click", exportCSV);
      $("btnExcel2").addEventListener("click", exportExcel);
      $("btnWord2").addEventListener("click", exportWord);
      $("btnPdf2").addEventListener("click", exportPDF);

      // Save / Load
      $("btnSaveDraft").addEventListener("click", saveDraft);
      $("btnLoadDraft").addEventListener("click", loadDraft);

      // Keyboard shortcuts
      document.addEventListener("keydown", (e) => {
        if (e.ctrlKey && e.key.toLowerCase() === "s") { e.preventDefault(); saveDraft(); }
        if (e.ctrlKey && e.key.toLowerCase() === "p") { e.preventDefault(); openPreview(); setTimeout(() => window.print(), 150); }
        if (e.key === "Escape") closePreview();
      });

      // CSV import
      $("csvImport").addEventListener("change", (e) => {
        const f = e.target.files && e.target.files[0];
        if (f) importCSV(f);
        e.target.value = "";
      });

      // Logo upload
      $("companyLogo").addEventListener("change", (e) => {
        const f = e.target.files && e.target.files[0];
        if (f) handleLogoUpload(f);
        e.target.value = "";
      });

      // Try auto-load last draft (non-intrusive): only if user already has one
      if (localStorage.getItem(DRAFT_KEY)) {
        loadDraft();
      }

      highlightActiveNav();
    }

    window.addEventListener("DOMContentLoaded", init);
  </script>

  <!-- If sync-nav.js exists, it can still run; this inline script already highlights active link. -->
</body>
</html>