<!DOCTYPE html>
<html lang="en-ZA">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EasyCashflow – Dashboard</title>
  <meta name="description" content="Cashflow overview: receivables, payables, VAT, inventory value (reads local data)." />
  <link rel="icon" href="icon.png" type="image/png">
  <link rel="apple-touch-icon" href="icon.png">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
/* EasyFile Add-ons */
:root{
  --primary:#2563eb; --primary2:#1d4ed8; --bg:#f5f7fb; --card:#ffffff;
  --text:#0f172a; --muted:#64748b; --border:#e2e8f0;
  --danger:#dc2626; --success:#16a34a;
}
body{background:var(--bg); color:var(--text);}
.card{background:var(--card); border:1px solid var(--border); border-radius:14px; box-shadow:0 10px 25px rgba(2,6,23,.05);}
.btn{display:inline-flex; align-items:center; justify-content:center; gap:.5rem; padding:.65rem 1rem; border-radius:10px; font-weight:800; transition: all .15s ease; border:1px solid transparent;}
.btn:hover{transform:translateY(-1px);}
.btn-primary{background:var(--primary); color:#fff;}
.btn-primary:hover{background:var(--primary2);}
.btn-outline{background:#fff; border-color:var(--border); color:var(--text);}
.btn-outline:hover{border-color:#cbd5e1; background:#f8fafc;}
.btn-danger{background:var(--danger); color:#fff;}
.mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;}
.responsive-table{overflow-x:auto; -webkit-overflow-scrolling:touch;}
.toast{position:fixed; right:16px; bottom:16px; z-index:9999;}
.toast>div{background:rgba(2,6,23,.92); color:#fff; border-radius:12px; padding:12px 14px; max-width:360px;}
@media print{ .no-print{display:none !important;} body{background:#fff !important;} .card{box-shadow:none !important; border:none !important;} }

  </style>
</head>
<body class="min-h-screen">

<nav class="bg-blue-600 text-white py-4 no-print">
  <div class="container mx-auto px-4 flex flex-wrap items-center gap-4">
    <a data-safe-link href="index.html" class="font-black text-xl mr-2">Easy&nbsp;Suite</a>
    &lt;a data-safe-link href=&quot;index.html&quot; class=&quot;hover:underline&quot;&gt;Home&lt;/a&gt;
      &lt;a data-safe-link href=&quot;easy-quote.html&quot; class=&quot;hover:underline&quot;&gt;Quote&lt;/a&gt;
      &lt;a data-safe-link href=&quot;easy-invoice.html&quot; class=&quot;hover:underline&quot;&gt;Invoice&lt;/a&gt;
      &lt;a data-safe-link href=&quot;easy-purchase-order.html&quot; class=&quot;hover:underline&quot;&gt;Purchase Order&lt;/a&gt;
      &lt;a data-safe-link href=&quot;easy-sales-order.html&quot; class=&quot;hover:underline&quot;&gt;Sales Order&lt;/a&gt;
      &lt;a data-safe-link href=&quot;easy-receipt.html&quot; class=&quot;hover:underline&quot;&gt;Receipt&lt;/a&gt;
      &lt;a data-safe-link href=&quot;easy-statement.html&quot; class=&quot;hover:underline&quot;&gt;Statement&lt;/a&gt;
      &lt;a data-safe-link href=&quot;easy-job-card.html&quot; class=&quot;hover:underline&quot;&gt;Job Card&lt;/a&gt;
      &lt;a data-safe-link href=&quot;easy-payroll.html&quot; class=&quot;hover:underline&quot;&gt;Payroll&lt;/a&gt;
      &lt;a data-safe-link href=&quot;easy-inventory.html&quot; class=&quot;hover:underline&quot;&gt;Inventory&lt;/a&gt;
      &lt;a data-safe-link href=&quot;easy-crm.html&quot; class=&quot;hover:underline&quot;&gt;CRM&lt;/a&gt;
      &lt;a data-safe-link href=&quot;easy-bill.html&quot; class=&quot;hover:underline&quot;&gt;Billing&lt;/a&gt;
      &lt;a data-safe-link href=&quot;easy-expenses.html&quot; class=&quot;hover:underline&quot;&gt;Expenses&lt;/a&gt;
      &lt;a data-safe-link href=&quot;easy-cashflow.html&quot; class=&quot;underline font-extrabold&quot;&gt;Cashflow&lt;/a&gt;
      &lt;a data-safe-link href=&quot;easy-vat.html&quot; class=&quot;hover:underline&quot;&gt;VAT&lt;/a&gt;
      &lt;a data-safe-link href=&quot;easy-credit-control.html&quot; class=&quot;hover:underline&quot;&gt;Credit&lt;/a&gt;
      &lt;a data-safe-link href=&quot;easy-projects.html&quot; class=&quot;hover:underline&quot;&gt;Projects&lt;/a&gt;
      &lt;a data-safe-link href=&quot;easy-assets-register.html&quot; class=&quot;hover:underline&quot;&gt;Assets&lt;/a&gt;
      &lt;a data-safe-link href=&quot;easy-timesheets.html&quot; class=&quot;hover:underline&quot;&gt;Timesheets&lt;/a&gt;
      &lt;a data-safe-link href=&quot;easy-leave.html&quot; class=&quot;hover:underline&quot;&gt;Leave&lt;/a&gt;
      &lt;a data-safe-link href=&quot;easy-approvals.html&quot; class=&quot;hover:underline&quot;&gt;Approvals&lt;/a&gt;
      &lt;a data-safe-link href=&quot;easy-contracts.html&quot; class=&quot;hover:underline&quot;&gt;Contracts&lt;/a&gt;
      &lt;a data-safe-link href=&quot;easy-popia.html&quot; class=&quot;hover:underline&quot;&gt;POPIA&lt;/a&gt;
      &lt;a data-safe-link href=&quot;easy-audit.html&quot; class=&quot;hover:underline&quot;&gt;Audit&lt;/a&gt;
      &lt;a data-safe-link href=&quot;easy-budgets.html&quot; class=&quot;hover:underline&quot;&gt;Budgets&lt;/a&gt;
      &lt;a data-safe-link href=&quot;easy-pos.html&quot; class=&quot;hover:underline&quot;&gt;POS&lt;/a&gt;
      &lt;a data-safe-link href=&quot;easy-insights.html&quot; class=&quot;hover:underline&quot;&gt;Insights&lt;/a&gt;
  </div>
</nav>

<main class="container mx-auto px-4 py-8">
  <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-6">
    <div>
      <h1 class="text-3xl font-extrabold text-slate-900">EasyCashflow – Dashboard</h1>
      <p class="text-sm text-slate-600 mt-1">Cashflow overview: receivables, payables, VAT, inventory value (reads local data).</p>
      <p class="text-xs text-slate-500 mt-1 mono">Store key: easy.cashflow.v1</p>
    </div>
    <div class="flex flex-wrap gap-2 no-print">
      <button class="btn btn-outline" id="btnSeed"><i class="fa-solid fa-seedling"></i> Seed Demo</button>
      <button class="btn btn-outline" id="btnImport"><i class="fa-solid fa-file-import"></i> Import JSON</button>
      <input id="fileJson" type="file" class="hidden" accept="application/json,.json" />
      <button class="btn btn-outline" id="btnExport"><i class="fa-solid fa-file-export"></i> Export</button>
      <button class="btn btn-outline" onclick="window.print()"><i class="fa-solid fa-print"></i> Print</button>
    </div>
  </div>


<section class="card p-5 mb-6">
  <div class="flex items-center justify-between gap-3">
    <div>
      <h2 class="text-lg font-black text-slate-900">Cashflow KPIs</h2>
      <p class="text-xs text-slate-500">Reads local invoice/expense/inventory data where available.</p>
    </div>
    <div class="flex gap-2 no-print">
      <button class="btn btn-outline" id="btnRefresh"><i class="fa-solid fa-rotate"></i> Refresh</button>
      <button class="btn btn-outline" id="btnExportReport"><i class="fa-solid fa-file-export"></i> Export Report</button>
    </div>
  </div>
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-4">
    <div class="card p-4"><div class="text-xs text-slate-500 font-black">Receivables</div><div id="k1" class="text-2xl font-black text-blue-700 mt-1">R0.00</div></div>
    <div class="card p-4"><div class="text-xs text-slate-500 font-black">Expenses (This Month)</div><div id="k2" class="text-2xl font-black text-rose-700 mt-1">R0.00</div></div>
    <div class="card p-4"><div class="text-xs text-slate-500 font-black">VAT Net</div><div id="k3" class="text-2xl font-black text-indigo-700 mt-1">R0.00</div></div>
    <div class="card p-4"><div class="text-xs text-slate-500 font-black">Inventory Value</div><div id="k4" class="text-2xl font-black text-emerald-700 mt-1">R0.00</div></div>
  </div>
</section>

</main>

<div class="toast hidden" id="toast"><div id="toastMsg"></div></div>

<script>

const $$ = (id) => document.getElementById(id);

function escapeHtml(str){
  return String(str || "").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
  }[m]));
}

function saveAs(blob, filename){
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.style.display = "none";
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ document.body.removeChild(a); URL.revokeObjectURL(url); }, 0);
}

function toast(msg){
  $$("toastMsg").textContent = msg;
  $$("toast").classList.remove("hidden");
  setTimeout(()=> $$("toast").classList.add("hidden"), 2500);
}

function nowISO(){ return new Date().toISOString(); }

function csvEscape(v){
  const s = String(v ?? "");
  if(/[",\n]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
  return s;
}
function toCSV(rows, headers){
  const head = headers.join(",");
  const body = rows.map(r => headers.map(h => csvEscape(r[h])).join(",")).join("\n");
  return head + "\n" + body + "\n";
}
function downloadJSON(data, filename){
  saveAs(new Blob([JSON.stringify(data,null,2)], {type:"application/json"}), filename);
}
function downloadCSV(rows, headers, filename){
  saveAs(new Blob([toCSV(rows, headers)], {type:"text/csv"}), filename);
}
function loadStore(key, fallback){
  try { return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }
  catch { return fallback; }
}
function saveStore(key, data){
  localStorage.setItem(key, JSON.stringify(data));
}


const STORE_KEY = "easy.cashflow.v1";
let data = loadStore(STORE_KEY, []);
function persist(){ saveStore(STORE_KEY, data); }

function importJSONFile(file){
  if(!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    try {
      const parsed = JSON.parse(reader.result);
      if(!Array.isArray(parsed)) throw new Error("Expected an array");
      data = parsed;
      persist();
      render();
      toast("Imported " + data.length + " rows");
    } catch(e) {
      console.error(e);
      toast("Import failed");
    }
  };
  reader.readAsText(file);
}

$("btnImport").addEventListener("click", ()=> $("fileJson").click());
$("fileJson").addEventListener("change", (e)=> importJSONFile(e.target.files[0]));
$("btnExport").addEventListener("click", ()=> exportAll());
$("btnSeed").addEventListener("click", ()=> seed());

function exportAll(){ downloadJSON(data, "easy-cashflow.json"); }


function money(n){ const x=Number(n||0); return "R"+x.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,","); }
function detectKey(prefixes){
  for(const k of Object.keys(localStorage)){
    for(const p of prefixes){ if(k===p || k.startsWith(p)) return k; }
  }
  return null;
}
function loadMaybe(key){ if(!key) return []; try{return JSON.parse(localStorage.getItem(key)||"[]");}catch{return [];} }
function sumReceivables(inv){
  return (Array.isArray(inv)?inv:[]).reduce((a,r)=>{
    const status=String(r.invoiceStatus||r.status||"").toLowerCase();
    const grand=Number(r.grand||r.total||r.amount||0);
    const paid=Number(r.paid||r.amountPaid||0);
    const bal=Number(r.balance||Math.max(0,grand-paid)||0);
    if(status.includes("paid")) return a;
    return a+bal;
  },0);
}
function sumVatOut(inv){ return (Array.isArray(inv)?inv:[]).reduce((a,r)=>a+Number(r.vat||r.vatTotal||0),0); }
function sumVatIn(exp){ return (Array.isArray(exp)?exp:[]).reduce((a,r)=>a+Number(r.vatAmt||r.vat||0),0); }
function expThisMonth(exp){
  const now=new Date(); const ym=now.getFullYear()+"-"+String(now.getMonth()+1).padStart(2,"0");
  return (Array.isArray(exp)?exp:[]).reduce((a,r)=> (String(r.date||r.ts||"").slice(0,7)===ym)? a+Number(r.amountIncl||r.amount||0):a,0);
}
function invValue(inv){ return (Array.isArray(inv)?inv:[]).reduce((a,r)=> a+(Number(r.stock||0)*Number(r.cost||0)),0); }

function refresh(){
  const invKey=detectKey(["easy.invoice.v2","easyinv","easy.invoice"]);
  const inv=loadMaybe(invKey);
  const exp=loadMaybe("easy.expenses.v1");
  const invt=loadMaybe("easy.inventory.v2");
  const k1=sumReceivables(inv);
  const k2=expThisMonth(exp);
  const k3=sumVatOut(inv)-sumVatIn(exp);
  const k4=invValue(invt);
  $$("k1").textContent=money(k1);
  $$("k2").textContent=money(k2);
  $$("k3").textContent=money(k3);
  $$("k4").textContent=money(k4);
}
function seed(){ toast("Seed Invoices/Expenses/Inventory for meaningful KPIs."); }
function exportAll(){
  const report={generatedAt:nowISO(), receivables:$$("k1").textContent, expensesThisMonth:$$("k2").textContent, vatNet:$$("k3").textContent, inventoryValue:$$("k4").textContent};
  downloadJSON(report,"easy-cashflow-report.json");
}
$$("btnRefresh").addEventListener("click", ()=>{refresh(); toast("Refreshed");});
$$("btnExportReport").addEventListener("click", exportAll);
function render(){ refresh(); }

render();
</script>
</body>
</html>
